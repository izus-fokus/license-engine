
name: License Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  
jobs:
  License-Check:
    runs-on: ubuntu-latest

    services:
      fossology:
        image: fossology/fossology:3.10.0
        ports:
          - 7100:80
    
    steps:
      - name: Get license engine
        uses: actions/checkout@v5
        with:
            repository: izus-fokus/license-engine

      - name: Clear the cache
        run: docker builder prune --force

      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag license-engine:0.0.1

      - name: Run license engine
        run: docker run -d --name=license-engine --network=host license-engine:0.0.1

      - name: Sleep for 10 seconds
        run: sleep 10s

      - name: Health check
        run: curl -X GET http://localhost:7000/api/v1/health

      - name: Run tests
        run: docker exec -i license-engine /bin/bash -c "mvn test"

      - name: Stop and remove container
        if: always()
        run: docker stop license-engine

      - name: Clear the cache
        run: docker image prune --all --force
        
#      - name: Download .license_ignorefiles file
#        continue-on-error: true
#        uses: carlosperate/download-file-action@v2
#        with:
#          file-url: 'https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/.license_ignorefiles'
#          file-name: '.license_ignorefiles'
#
#      - name: Get defined license of repository
#        id: get_repo_license
#        continue-on-error: true
#        uses: octokit/request-action@v2.x
#        with:
#          route: GET /repos/${{ github.repository }}/license
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Echo defined license of repository
#        if: steps.get_repo_license.outcome == 'success'
#        run: "echo defined license: ${{ fromJson(steps.get_repo_license.outputs.data).license.spdx_id }}"
#
#      - name: Run License Engine with predefined license to be checked against
#        if: steps.get_repo_license.outcome == 'success'
#        run: java -jar target/licenseengine-0.0.1-SNAPSHOT.jar --repo=$GITHUB_REPOSITORY --branch=$GITHUB_REF_NAME --license=${{ fromJson(steps.get_repo_license.outputs.data).license.spdx_id }}
#
#      - name: Run License Engine without predefined license to be checked against
#        if: steps.get_repo_license.outcome != 'success'
#        run: java -jar target/licenseengine-0.0.1-SNAPSHOT.jar --repo=$GITHUB_REPOSITORY --branch=$GITHUB_REF_NAME
